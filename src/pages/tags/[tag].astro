---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const uniqueTags = new Set<string>();

  allPosts.forEach(post => {
    post.data.tags.forEach(tag => {
      uniqueTags.add(tag.toLowerCase());
    });
  });

  return Array.from(uniqueTags).map(tag => ({
    params: { tag },
    props: { tagName: tag }
  }));
}

const { tag } = Astro.params;
const { tagName } = Astro.props;

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const filteredPosts = allPosts
  .filter(post => post.data.tags.some(t => t.toLowerCase() === tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

function formatDate(date: Date) {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

const displayTag = filteredPosts[0]?.data.tags.find(t => t.toLowerCase() === tag) || tagName;
---

<BaseLayout title={`Posts tagged: ${displayTag}`} description={`All posts tagged with ${displayTag}`}>
  <div style="max-width: 720px; margin: 0 auto; padding: 0 1.5rem;">

    <div style="padding: 2rem 0 1rem;">
      <a
        href="/tags"
        style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--color-accent); text-decoration: none;"
      >
        &larr; All tags
      </a>
    </div>

    <section style="padding: 1rem 0 2rem;">
      <h1 style="font-family: var(--font-display); font-weight: 400; font-size: clamp(1.5rem, 4vw, 2.25rem); line-height: 1.2; margin: 0 0 0.5rem 0; color: var(--color-text-primary);">
        {displayTag}
      </h1>
      <p style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--color-text-secondary);">
        {filteredPosts.length} {filteredPosts.length === 1 ? 'post' : 'posts'}
      </p>
    </section>

    <section style="padding: 0 0 4rem;">
      <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        {filteredPosts.map((post) => (
          <a
            href={`/blog/${post.slug}`}
            class="project-card"
            style="text-decoration: none; color: inherit; display: block;"
          >
            <time
              datetime={post.data.pubDate.toISOString()}
              style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--color-text-secondary);"
            >
              {formatDate(post.data.pubDate)}
            </time>
            <h2 style="font-family: var(--font-display); font-weight: 500; font-size: 1.15rem; margin: 0.3rem 0 0.4rem 0; color: var(--color-text-primary);">
              {post.data.title}
            </h2>
            <p style="font-family: var(--font-body); font-size: 0.9rem; color: var(--color-text-secondary); margin: 0; line-height: 1.5;">
              {post.data.description}
            </p>
          </a>
        ))}
      </div>
    </section>

  </div>
</BaseLayout>
